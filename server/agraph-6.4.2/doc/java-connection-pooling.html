<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml' xml:lang='en' lang='en'>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="author" content="Franz Incorporated"/>
<title>Java Connection Pooling | AllegroGraph 6.4.2</title>
<link rel='stylesheet' href='jquery-ui.custom.min.css' />
<link rel='stylesheet' href='stylesheet.css' />
<link rel='stylesheet' href='print.css' media='print' />
<body id="java-connection-pooling"> <div id="header"> <p>                 </p>                <p><script src="jquery.min.js" type="text/javascript" charset="utf-8"></script> <script src="jquery-ui.custom.min.js" type="text/javascript" charset="utf-8"></script> <script src="activebookmark.js" type="text/javascript" charset="utf-8"></script> </p> <div id='search-form'>   <form method="GET" action="https://www.google.com/search">     <input type="hidden" name="as_sitesearch" value=""> </input>     <input type="text" size="40" name="as_q" value="" placeholder="Please enable JavaScript to use search!"> </input>&nbsp;     <input type="submit" value="Search" disabled> </input>   </form> </div> <script>    /* Docudown has no support for function calls in HTML attributes. 
<ul>
<li>Thus, we set the as_sitesearch attribute using JavaScript below.    */   (function () { 'use strict'; var properValue = "franz.com/agraph/support/documentation/6.4.2/"; var input = document.querySelector(   '#search-form input[name="as_sitesearch"]'); input.setAttribute('value', properValue); /* The submit button was disabled so that search would be 
<ul>
<li>impossible for users without JavaScript. Enabling now: */ document.querySelector('#search-form input[type="submit"]').   removeAttribute('disabled'); document.querySelector('#search-form input[name="as_q"]').   removeAttribute('placeholder');   })(); </script> <div id="copyright">  Copyright (c) 2005 - 2018 Franz, Incorporated</div> <div id="timestamp">  Last updated 8 June 2018 at 06:55</div> <a href="https://franz.com" alt="Franz Inc Home Page"><div id="hdLogo"> </div></a> </li></ul></li></ul>       <h1>Java Connection Pooling 6.4.2</h1></div> <div id="contents">  <div id="docIndex"> <ul id="agmenu"> <li><a href="index.html">Documentation Index</a> 
<ul>
<li><a href="release-notes.html">Release Notes</a></li>
<li><a href="agraph-quick-start.html">Quick Start</a></li>
<li><a href="agraph-introduction.html" id="agraph-introduction-tab">Introduction</a></li>
<li>Setup and Configuration
<ul>
<li><a href="http://franz.com/agraph/downloads/" target="_blank">Download</a></li>
<li><a href="server-installation.html">Server Installation</a></li>
<li><a href="daemon-config.html">Server Configuration and Control</a></li>
<li><a href="agwebview.html">WebView</a></li>
<li><a href="upgrade-guide.html">Database Upgrading</a></li></ul></li>
<li>Server Management
<ul>
<li><a href="performance-tuning.html">Performance Tuning</a></li>
<li><a href="deleting-duplicate-triples.html">Deleting Duplicate Triples</a></li>
<li><a href="purging-deleted-triples.html">Purging Deleted Triples</a></li>
<li><a href="audit.html">Auditing</a></li>
<li><a href="managing-users.html">Managing Users</a></li>
<li><a href="replication.html">Replication</a></li>
<li><a href="point-in-time-recovery.html">Point-in-Time Recovery</a></li>
<li><a href="transaction-log-archiving.html">Transaction Log Archiving</a></li>
<li><a href="security-overview.html">Security Overview</a></li>
<li><a href="security.html">Security Implementation</a></li></ul></li>
<li>Tools
<ul>
<li><a href="agtool.html">agtool</a></li>
<li><a href="agload.html">Data Loading</a></li>
<li><a href="agexport.html">Data Export</a></li>
<li><a href="backup-and-restore.html">Backup and Restore</a></li>
<li><a href="agquery.html">Querying</a></li>
<li><a href="reasoner-tutorial.html" id="reasoner-tutorial-tab">RDFS++</a></li>
<li><a href="materializer.html">Materializer</a></li></ul></li>
<li>Details
<ul>
<li><a href="triple-index.html">AllegroGraph Indices</a></li>
<li><a href="text-index.html">Full-text Indices</a></li>
<li><a href="encoded-ids.html">Encoded IDs</a></li>
<li><a href="connection-pooling.html">Connection Pooling</a></li>
<li><a href="geospatial-nd.html">N-dimensional Geospatial Overview</a></li>
<li><a href="magic-properties.html#sparql-magic-geo-2d">2-D Geospatial</a></li>
<li><a href="magic-properties.html#sparql-magic-temporal">Temporal</a></li>
<li><a href="magic-properties.html#sparql-magic-sna">Social Network</a></li>
<li><a href="javascript.html">JavaScript</a></li>
<li><a href="datatypes.html">Datatypes</a></li>
<li><a href="rapper.html">Data Conversion (Rapper)</a></li>
<li><a href="stored-procedures.html">Stored Procedures</a></li>
<li><a href="triple-attributes.html">Triple Attributes</a></li></ul></li>
<li>Querying
<ul>
<li><a href="sparql-overview.html">SPARQL documentation summary</a></li>
<li><a href="sparql-reference.html">SPARQL Reference</a></li>
<li><a href="spin.html">SPIN</a></li>
<li><a href="magic-properties.html">SPARQL Magic Properties</a></li>
<li><a href="prolog-tutorial.html">Prolog</a></li></ul></li>
<li>3rd-party tools
<ul>
<li><a href="solr-index.html">Solr text Indices</a></li>
<li><a href="mongo-interface.html">MongoDB integration</a></li>
<li><a href="TBCplugin.html">TopBraid Composer Plugin</a></li>
<li><a href="agraph-introduction.html#othertools">Cloudera</a></li></ul></li>
<li>Client APIs
<ul>
<li><a href="http://franz.com/agraph/gruff/" title="Gruff" target="_blank">Gruff</a></li>
<li><a href="http-protocol.html">REST/HTTP interface</a></li>
<li><a href="http-reference.html">HTTP reference</a></li>
<li><a href="javadoc/index.html">Javadocs (Sesame and Jena)</a></li>
<li><a href="python/index.html">Python API</a></li>
<li><a href="lisp-reference.html">Lisp Reference</a></li>
<li><a href="javascript.html">JavaScript</a></li></ul></li>
<li>Tutorials
<ul>
<li><a href="geospatial-nd-tutorial.html">N-dimensional Geospatial</a></li>
<li><a href="sparql-tutorial.html">SPARQL Tutorial</a></li>
<li><a href="java-tutorial/java-tutorial.html">Java Sesame</a></li>
<li><a href="java-tutorial/jena-tutorial.html">Java Jena</a></li>
<li><a href="python/tutorial.html">Python Sesame</a></li>
<li><a href="lisp-quickstart.html">Lisp</a></li>
<li><a href="prolog-tutorial.html">Prolog</a></li>
<li><a href="tutorial-index.html">More...</a></li></ul></li>
<li>Other
<ul>
<li><a href="suggested-reading.html">Suggested Reading</a></li>
<li><a href="http://franz.com/ps/services/conferences_seminars/" title="Conferences and Seminars" target="_blank">Conferences and Seminars</a></li>
<li><a href="http://github.com/franzinc">Source Code on Github</a></li>
<li><a href="http://agraph.franz.com/cresources/index.lhtml" target="_blank">Community Resources</a></li>
<li><a href="http://franz.com/agraph/ec2/">Amazon EC2</a></li>
<li><a href="copyrights.html">Copyrights</a></li>
<li><a href="change-history.html" id="change-history-tab">Change History</a></li></ul></li>
<li><a href="http://franz.com/" target="_blank">Franz, Inc.</a> </li> </ul> </li></ul><p><script> $(function() { $( "#agmenu" ).menu(); }); </script> </p></div>   
<div class='table-of-contents' id='table-of-contents'>

<ul>
<li><a href='#header2-8' title='AllegroGraph Java Connection Pooling introduction'>AllegroGraph Java Connection Pooling introduction</a></li>
<li><a href='#header2-12' title='Features'>Features</a></li>
<li><a href='#header2-19' title='Lifetime of the Pool'>Lifetime of the Pool</a></li>
<li><a href='#header2-24' title='Lifetime of Connections'>Lifetime of Connections</a></li>
<li><a href='#header2-29' title='Libraries'>Libraries</a></li></ul>
<div id='tocLink'><a href='index.html'>Documentation Index</a></div>
</div>
  <div id="main-content"> <a name='header2-8' id='header2-8'></a><h2>AllegroGraph Java Connection Pooling introduction</h2><p>The relevant package in the <a href="javadoc/index.html">Javadocs</a> is <a href="javadoc/com/franz/agraph/pool/package-summary.html" title="Package" target="_blank">com.franz.agraph.pool</a>. </p><p>The agraph-java-client library now has a feature for pooling connections to the AllegroGraph server. This is useful in webserver and appserver applications where many threads need to access the same AllegroGraph database.  By using a pool of connections, AllegroGraph server resources can be minimized while supporting concurrent access. </p><p>The API to the pool is the <code>AGConnPool</code> class in the <code>com.franz.agraph.pool</code> package.  AGConnPool may be configured in code, or through JNDI with the <code>AGConnPoolJndiFactory</code> class.  The AGConnPool implements <code>ObjectPool</code> from the Apache commons-pool library, and the objects it manages are <code>AGRepositoryConnection</code>.  More details can be found in the javadocs. </p><a name='header2-12' id='header2-12'></a><h2>Features</h2><p>The features of the pool are exposed through properties so it may be configured in JNDI or java code. </p><p>Related to the connection itself are properties: <code>serverUrl</code>, <code>catalog</code>, <code>repository</code>, <code>username</code>, <code>password</code>, <code>session</code>, and <code>sessionLifetime</code>. The session configures whether connections are shared, dedicated (<code>autoCommit</code>), or dedicated/transactional - it is recommended that applications set this appropriately on the pool, then not change the <code>setAutoCommit</code> property of the connection within the application code. The <code>sessionLifetime</code> helps manage server resources and is discussed more below. </p><p>Note that users of the pool will share the same connections and sessions (though not concurrently).  For example, all connections will have the same repository and username.  If different properties are needed, then multiple pools must be configured. </p><p>Not all features of the agraph-java-client library are supported yet in the pool properties.  This includes managing catalogs and repositories, server scripts, rules, SNA, mappings, bulkMode, duplicates, and federation.  These features must be managed in application code, and care must be taken since the connections will be reused after returning to the pool. </p><p>Related to the pooling mechanism are more properties: <code>initialSize</code>, <code>shutdownHook</code> (discussed below), <code>maxActive</code>, <code>maxWait</code>, <code>testOnBorrow</code>, and <code>testOnReturn</code>.  <code>MaxActive</code> is important to limit server resources.  The correct number is dependent on server resources and how many concurrent requests need to be handled.  The server should have some number of <code>SessionPorts</code> configured based on machine resources, and to avoid running out of sessions, all possible pools (usually different JVMs) should have <code>maxActive</code> be a fraction of that number so that they can't request more than the server has.  <code>MaxWait</code> is important so that borrowing a connection does not block your application request forever - it should be set to approximately the longest tolerable time a request should last before failing. TestOnBorrow is important so the application does not try to use stale connections, usually resulting in a "connection refused" error because the server session has been reclaimed due to inactivity (see <code>sessionLifetime</code>). </p><p>Also, commons-pool will run a background "eviction thread" based on these properties: <code>maxIdle</code>, <code>minIdle</code>, <code>testWhileIdle</code>, <code>timeBetweenEvictionRunsMillis</code>, <code>minEvictableIdleTimeMillis</code>, <code>softMinEvictableIdleTimeMillis</code>, and <code>numTestsPerEvictionRun</code>. This may reduce time that a request waits for a connection if <code>testOnBorrow</code> were called, and a new connection is established. </p><a name='header2-19' id='header2-19'></a><h2>Lifetime of the Pool</h2><p>Care must be taken with the lifetime of the pool.  Like all resource objects in Java, it must be closed/shutdown properly.  Note that AllegroGraph server sessions are OS processes that must be closed explicitly - there is not a persistent socket connection for it to know when the client disappears, so close must be called.  The server sessions should have a lifetime set so they will end after inactivity; the javadoc has more details as well as the <a href="http-protocol.html#post-session">server http protocol</a>. </p><p><code>AGConnPool</code> supports a property called shutdownHook to register itself with the JVM to shutdown resources before the JVM exits - this is a good last resort, but is not guaranteed and may not be as timely as other means.  The lifetime of the pool may be controlled by the web/appserver based on JNDI configuration.  A <code>shutdownHook</code> is not always appropriate, as in a webapp if the pool library exists within the application instead of configured with the web/appserver JNDI.  In particular, if the shutdownHook is used and the webserver undeploys the pool without closing it, the shutdownHook will become the source of a leak, keeping the pool object, connections, and classes alive in the JVM.  Closing a pool will remove its <code>shutdownHook</code> if there is one. </p><p>For webapps directly controlling the pool (not by JNDI), an easy way to manage the lifecycle of the pool is by implementing a <code>javax.servlet.ServletContextListener</code> to create and shutdown the pool, keeping the pool object where it can be accessed during requests. </p><p>When configuring the pool in JNDI with Tomcat, a <a href="http://tomcat.apache.org/tomcat-6.0-doc/config/context.html#Lifecycle_Listeners" title="Lifecycle Listeners" class="external" target="_blank">Lifecycle Listener</a> can be implemented and configured. </p><a name='header2-24' id='header2-24'></a><h2>Lifetime of Connections</h2><p>Connections (class <code>AGRepositoryConnection</code>) must not be used by concurrent threads.  The agraph-java library, and supporting libraries (Jena and RDF4J), are not built to be thread-safe. </p><p>Connections are borrowed from the pool just before use, and returned to the pool as soon as the thread is done with it.  The return of the connection (method <code>pool.returnObject(connection)</code> or <code>connection.close()</code>) must be done in a finally block to ensure the connection is not leaked. </p><p>If a connection is leaked, the <code>sessionLifetime</code> (if used) will cause the server process to be closed eventually, and the only leak will be the connection objects in JVM memory, until the pool is shutdown.  If <code>sessionLifetime</code> is not set, the AllegroGraph server may run out of resources or session ports, new connections will fail, and the server process must be killed by an admin. </p><p>For webapps, an easy way to manage the lifecycle of connections is by implementing a <code>javax.servlet.ServletRequestListener</code> to borrow and return a connection from the pool and keep it in a <code>ThreadLocal</code>.  This may not be the most efficient use of connections if requests last significantly longer than the connection is really used. </p><a name='header2-29' id='header2-29'></a><h2>Libraries</h2><p>This library uses the Apache commons-pool library for the underlying pool functionality. </p><p>If the pool is to be configured in a webserver with JNDI, the webserver will need access to the agraph jar and all of it's dependencies (RDF4J, Jena, commons-httpclient, commons-pool, logging, etc). </p><p>Alternatively, if the application is configuring AGConnPool directly, the agraph jar and its dependencies may be packaged with the application. </p><p>The agraph-java-client library uses the SLF4J API for logging, so you can choose the implementation <a href="http://www.slf4j.org/" title="SLF4J" class="external" target="_blank)." Connections="whose" server="session" has="expired" (see="sessionLifetime">see www.slf4j.org</a> will log exceptions as DEBUG, but automatically recover.  Apache commons-httpclient will log http errors and exceptions to INFO even though agraph-java ends up recovering. </p></div>  <p><script> $.each($("#agmenu ul li a"), function(ignore, link) {   var anchor = $(link);   anchor.parent().on("click", function () { window.location = anchor.prop("href"); }); }); $("#agmenu").css("display", "block") </script> </p> 
</body>
</html>
